<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<title>Universal Pay Link</title>
<meta name="description" content="One QR, any money. Bank & instant rails, Swiss QR-bill, UPI, Pix, Lightning, BTC, Solana, PayPal/Revolut, and more.">

<style>
  :root{
    --bg:#0b0c10; --surface:#10141a; --surface2:#0f1318;
    --border:#222a35; --text:#e7e9ea; --muted:#9aa4b2;
    --accent:#22d3ee; --accent2:#7dd3fc; --radius:16px; --maxw:980px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:
      radial-gradient(1200px 600px at 20% -10%, rgba(34,211,238,.08), transparent 50%),
      radial-gradient(1200px 600px at 100% 10%, rgba(125,211,252,.08), transparent 40%),
      var(--bg);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    line-height:1.45;
  }
  a{color:#b7d3ff; text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:var(--maxw); margin:0 auto; padding:20px}
  header{display:flex; align-items:center; gap:16px; margin:6px 0 16px}
  header img{width:56px; height:56px; border-radius:50%; object-fit:cover; background:#1a1f28; border:1px solid var(--border)}
  h1{font-size:22px; margin:0}
  .muted{color:var(--muted)}
  .tag{display:inline-block; border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; margin-right:8px; color:var(--muted)}

  .card{background:linear-gradient(180deg,var(--surface),var(--surface2)); border:1px solid var(--border); border-radius:var(--radius); padding:18px; margin:12px 0; box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .col{flex:1 1 360px}

  .hero{
    display:grid; 
    grid-template-columns: 220px 1fr; 
    gap:18px; 
    align-items:center
  }
  @media (max-width:820px){ 
    .hero{
      grid-template-columns:1fr;
      text-align: center;
    }
    .hero .actions {
      justify-content: center;
    }
  }
  
  /* Responsive adjustments for small screens */
  @media (max-width:480px) {
    .wrap {
      padding: 12px;
    }
    .card {
      padding: 14px;
      margin: 10px 0;
    }
    .qr {
      width: 200px;
      height: 200px;
      margin: 0 auto;
    }
    .input {
      flex-direction: column;
      gap: 8px;
    }
    .txt {
      min-width: 100%;
    }
    .chipbar {
      justify-content: center;
    }
  }

  .qr{background:#fff; border-radius:12px; width:220px; height:220px; display:flex; align-items:center; justify-content:center}

  .input{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px}
  .txt{flex:1 1 160px; min-width:160px; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#0f131a; color:var(--text)}
  .chipbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .chip{
    padding:6px 12px; 
    border:1px solid var(--border); 
    border-radius:999px; 
    background:#141a22; 
    cursor:pointer;
    transition: background-color 0.2s, border-color 0.2s;
    font-weight: 500;
  }
  .chip:hover{
    border-color:#2e3846;
    background-color: #1a2230;
  }
  .chip:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .btn{
    display:inline-flex; 
    align-items:center; 
    justify-content:center; 
    gap:10px; 
    padding:12px 16px; 
    border:1px solid var(--border); 
    border-radius:12px; 
    background:#141a22; 
    color:var(--text); 
    text-decoration:none; 
    cursor:pointer; 
    transition: background-color 0.2s, border-color 0.2s, transform .08s ease;
    font-weight: 500;
  }
  .btn:hover{
    transform:translateY(-1px); 
    border-color:#2e3846;
    background-color: #1a2230;
  }
  .btn:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .btn.primary{
    background:linear-gradient(180deg,#14232c,#111820); 
    border-color:#294050;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .btn.primary:hover {
    background:linear-gradient(180deg,#1a2d3a,#162229);
    border-color:#3a5269;
  }
  .btn.small{
    padding:8px 10px; 
    font-size:13px;
  }

  .railgrid{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
  @media (max-width:820px){ .railgrid{grid-template-columns: repeat(2, 1fr)} }
  @media (max-width:480px){ .railgrid{grid-template-columns: 1fr} }
  
  .rail-section {
    margin-top: 24px;
    margin-bottom: 16px;
    border-top: 1px solid var(--border);
    padding-top: 16px;
  }
  
  .rail-section h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 12px;
    color: var(--accent2);
    padding-left: 4px;
  }
  
  .rail{
    display:flex; 
    align-items:center; 
    gap:10px; 
    border:1px solid var(--border); 
    border-radius:12px; 
    background:#141a22; 
    padding:12px; 
    cursor:pointer;
    transition: background-color 0.2s, border-color 0.2s;
  }
  .rail:hover{
    border-color:#2e3846;
    background-color: #1a2230;
  }
  .rail:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  .rail svg{width:20px; height:20px}
  .rail small{color:var(--muted)}

  footer{opacity:.7; font-size:12px; margin:28px 0; text-align:center}

  /* Modal sheet */
  .sheet{
    position:fixed; 
    inset:0; 
    display:none; 
    align-items:flex-end; 
    justify-content:center; 
    background:rgba(0,0,0,.65); 
    z-index:50;
    backdrop-filter: blur(3px);
  }
  .sheet.on{display:flex !important}
  .sheet .panel{
    background:linear-gradient(180deg,var(--surface),var(--surface2)); 
    border:1px solid var(--border); 
    border-radius:18px 18px 0 0; 
    padding:18px; 
    width:min(720px,100%); 
    max-height:85vh; 
    overflow:auto;
    box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
  }
  .sheet .head{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px}
  .sheet .title{font-weight:600; font-size: 18px;}
  .sheet .grid2{display:grid; grid-template-columns:1fr 220px; gap:20px}
  @media (max-width:760px){ .sheet .grid2{grid-template-columns:1fr} }
  .qrbox{display:flex; flex-direction:column; align-items:center; gap:12px}
  .qrbox .qr{
    background:#fff; 
    border-radius:12px; 
    width:220px; 
    height:220px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .note{font-size:12px; color:var(--muted)}
  .muted{color:var(--muted)}
  
  /* Screen reader only class */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <img id="avatar" alt="">
    <div>
      <h1 id="title">Universal Pay Link</h1>
      <div class="muted" id="subtitle">One QR, any money.</div>
      <div id="meta"></div>
    </div>
  </header>

  <!-- HERO: ONE universal QR -->
  <div class="card">
    <div class="hero">
      <div style="display:flex; flex-direction:column; align-items:center; gap:10px">
        <div id="universalQr" class="qr">
          <!-- Pre-generated QR code image -->
          <img src="data:image/png;base64,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" alt="Universal QR Code" style="width:100%; height:100%;">
        </div>
        <div class="actions">
          <button class="btn small" id="copylink" aria-label="Copy payment link to clipboard">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
            </svg>
            Copy link
          </button>
          <button class="btn small" id="share" aria-label="Share payment link">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="18" cy="5" r="3"></circle>
              <circle cx="6" cy="12" r="3"></circle>
              <circle cx="18" cy="19" r="3"></circle>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
            </svg>
            Share
          </button>
        </div>
      </div>

      <div>
        <div class="muted">Set amount / note (optional). The QR updates live.</div>
        <div class="input">
          <label for="amount" class="sr-only">Amount</label>
          <input id="amount" class="txt" inputmode="decimal" placeholder="Amount (e.g., 35)" aria-label="Payment amount">
          <label for="note" class="sr-only">Note</label>
          <input id="note" class="txt" maxlength="80" placeholder="Note (e.g., haircut)" aria-label="Payment note or description">
          <label for="fiat" class="sr-only">Currency</label>
          <input id="fiat" class="txt" maxlength="4" placeholder="Currency (CHF, EUR, USD)" aria-label="Currency code">
        </div>
        <div class="chipbar" id="chips"></div>
        <div class="actions" style="margin-top:14px">
          <a id="primaryCta" class="btn primary" href="#" target="_blank" rel="noopener" aria-label="Pay with primary payment method">
            <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v20M2 12h20"></path>
            </svg>
            Pay Now
          </a>
          <a class="btn" href="#rails" aria-label="View all payment options">
            <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"></path>
            </svg>
            More options
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- RAILS -->
  <div id="railsCard" class="card">
    <h2 style="font-size: 20px; margin-top: 0; margin-bottom: 16px;">Choose a Payment Method</h2>
    <div id="rails"></div>
    
    <!-- Fallback payment options (in case dynamic loading fails) -->
    <div class="rail-section">
      <h3>Bank Transfer Options</h3>
      <div class="railgrid">
        <div class="rail" role="button" tabindex="0" aria-label="Pay with IBAN / SEPA: CH4431999123000889012" 
          onclick="document.getElementById('sepaPaymentSheet').style.display='block'; setTimeout(function() { 
            var qrElement = document.getElementById('sepa-qr');
            qrElement.innerHTML = '';
            new QRCode(qrElement, {
              text: 'CH4431999123000889012',
              width: 220,
              height: 220,
              colorDark: '#000000',
              colorLight: '#FFFFFF',
              correctLevel: QRCode.CorrectLevel.H
            });
          }, 100); return false;">
          <svg viewBox="0 0 24 24" fill="none"><path d="M3 10h18M5 10v8m4-8v8m4-8v8m4-8v8M2 20h20M12 4l9 6H3l9-6Z" stroke="currentColor" stroke-width="1.4"/></svg>
          <div><div>IBAN / SEPA</div><small>CH4431999123000889012</small></div>
        </div>
        <div class="rail" role="button" tabindex="0" aria-label="Pay with Swiss QR‑bill: CH/LI IBAN" 
          onclick="document.getElementById('swissPaymentSheet').style.display='block'; setTimeout(function() { 
            var qrElement = document.getElementById('swiss-qr');
            qrElement.innerHTML = '';
            new QRCode(qrElement, {
              text: 'CH4431999123000889012',
              width: 220,
              height: 220,
              colorDark: '#000000',
              colorLight: '#FFFFFF',
              correctLevel: QRCode.CorrectLevel.H
            });
          }, 100); return false;">
          <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.4"/><path d="M12 7v10M7 12h10" stroke="currentColor" stroke-width="1.6"/></svg>
          <div><div>Swiss QR‑bill</div><small>CH/LI IBAN</small></div>
        </div>
        <div class="rail" role="button" tabindex="0" aria-label="Pay with UPI: demobarber@upi" 
          onclick="document.getElementById('upiPaymentSheet').style.display='block'; setTimeout(function() { 
            var qrElement = document.getElementById('upi-qr');
            qrElement.innerHTML = '';
            new QRCode(qrElement, {
              text: 'upi://pay?pa=demobarber@upi',
              width: 220,
              height: 220,
              colorDark: '#000000',
              colorLight: '#FFFFFF',
              correctLevel: QRCode.CorrectLevel.H
            });
          }, 100); return false;">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 12h16M12 4v16" stroke="currentColor" stroke-width="1.4"/></svg>
          <div><div>UPI</div><small>demobarber@upi</small></div>
        </div>
      </div>
    </div>
    
    <div class="rail-section">
      <h3>Cryptocurrency Options</h3>
      <div class="railgrid">
        <div class="rail" role="button" tabindex="0" aria-label="Pay with ⚡ Lightning: demo@lightningaddress.com" onclick="javascript:window.openRail('Lightning');return false;">
          <svg viewBox="0 0 24 24" fill="none"><path d="M13 2L3 14h7l-1 8 10-12h-7l1-8Z" stroke="currentColor" stroke-width="1.2"/></svg>
          <div><div>⚡ Lightning</div><small>demo@lightningaddress.com</small></div>
        </div>
        <div class="rail" role="button" tabindex="0" aria-label="Pay with Bitcoin: bc1qexampleaddress0000000000000000000000k3" onclick="javascript:window.openRail('BTC');return false;">
          <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.4"/><path d="M9 8h5a2 2 0 110 4H9h6a2 2 0 110 4H9m2-10v12" stroke="currentColor" stroke-width="1.2"/></svg>
          <div><div>Bitcoin</div><small>bc1qexampleaddress0000000000000000000000k3</small></div>
        </div>
      </div>
    </div>
    
    <div class="rail-section">
      <h3>Payment Apps & Services</h3>
      <div class="railgrid">
        <div class="rail" role="button" tabindex="0" aria-label="Pay with PayPal.Me: demobarber" onclick="javascript:window.openRail('PayPal');return false;">
          <svg viewBox="0 0 24 24" fill="none"><path d="M3 7h18v10H3z" stroke="currentColor" stroke-width="1.4"/><path d="M3 10h18" stroke="currentColor" stroke-width="1.2"/></svg>
          <div><div>PayPal.Me</div><small>demobarber</small></div>
        </div>
        <div class="rail" role="button" tabindex="0" aria-label="Pay with Revolut.me: demobarber" onclick="javascript:window.openRail('Revolut');return false;">
          <svg viewBox="0 0 24 24" fill="none"><path d="M3 7h18v10H3z" stroke="currentColor" stroke-width="1.4"/><path d="M3 10h18" stroke="currentColor" stroke-width="1.2"/></svg>
          <div><div>Revolut.me</div><small>demobarber</small></div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    Open source. Non‑custodial routing. Host on GitHub Pages. — <a href="make.html">Make your UPL</a>
  </footer>
</div>

<!-- Modal sheet -->
<div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" style="display:none;">
  <div class="panel">
    <div class="head">
      <div class="title" id="sheetTitle">Pay</div>
      <button id="closeSheet" class="btn small" aria-label="Close payment details">
        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        Close
      </button>
    </div>
    <div id="sheetBody" class="grid2">
      <!-- left: info + buttons; right: QR -->
    </div>
  </div>
</div>

<!-- Inline payment sheet for demo -->
<div id="inlinePaymentSheet" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:100; padding:20px; overflow:auto;">
  <div style="max-width:800px; margin:40px auto; background:#1a2230; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 id="inlineSheetTitle" style="margin:0; font-size:24px;">Payment Details</h2>
      <button onclick="document.getElementById('inlinePaymentSheet').style.display='none';" style="background:none; border:1px solid #3a4555; border-radius:8px; padding:8px 12px; color:white; cursor:pointer;">Close</button>
    </div>
    <div id="inlineSheetContent" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
      <!-- Content will be inserted here -->
    </div>
  </div>
</div>

<!-- Direct SEPA payment sheet -->
<div id="sepaPaymentSheet" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:100; padding:20px; overflow:auto;">
  <div style="max-width:800px; margin:40px auto; background:#1a2230; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0; font-size:24px;">Pay via IBAN / SEPA</h2>
      <button onclick="document.getElementById('sepaPaymentSheet').style.display='none';" style="background:none; border:1px solid #3a4555; border-radius:8px; padding:8px 12px; color:white; cursor:pointer;">Close</button>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
      <div>
        <div class="muted">Many EU bank apps scan this and pre‑fill. If available, pick <b>Instant</b> in your bank app. Same QR works for Instant.</div>
        <div style="margin-top:8px"><code>CH4431999123000889012</code></div>
        <div style="margin-top:16px">
          <a href="#" target="_blank" rel="noopener" class="btn primary" style="margin-right:10px;">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
            Open
          </a>
          <button onclick="navigator.clipboard.writeText('CH4431999123000889012');" class="btn">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
            </svg>
            Copy
          </button>
        </div>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center;">
        <div id="sepa-qr-container" style="width:220px; height:220px; background:#fff; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
          <!-- Pre-generated QR code image -->
          <img src="data:image/png;base64,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" alt="SEPA QR Code" style="width:100%; height:100%;">
        </div>
        <button onclick="alert('QR code download not implemented yet');" class="btn small" style="margin-top:10px;">
          <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Download QR
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Swiss QR-bill payment sheet -->
<div id="swissPaymentSheet" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:100; padding:20px; overflow:auto;">
  <div style="max-width:800px; margin:40px auto; background:#1a2230; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0; font-size:24px;">Pay via Swiss QR-bill</h2>
      <button onclick="document.getElementById('swissPaymentSheet').style.display='none';" style="background:none; border:1px solid #3a4555; border-radius:8px; padding:8px 12px; color:white; cursor:pointer;">Close</button>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
      <div>
        <div class="muted">Swiss QR-bill for CH/LI IBAN accounts. Scan with your Swiss banking app.</div>
        <div style="margin-top:8px"><code>CH4431999123000889012</code></div>
        <div style="margin-top:16px">
          <a href="#" target="_blank" rel="noopener" class="btn primary" style="margin-right:10px;">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
            Open
          </a>
          <button onclick="navigator.clipboard.writeText('CH4431999123000889012');" class="btn">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
            </svg>
            Copy
          </button>
        </div>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center;">
        <div id="swiss-qr-container" style="width:220px; height:220px; background:#fff; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
          <!-- Pre-generated QR code image -->
          <img src="data:image/png;base64,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" alt="Swiss QR-bill Code" style="width:100%; height:100%;">
        </div>
        <button onclick="alert('QR code download not implemented yet');" class="btn small" style="margin-top:10px;">
          <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Download QR
        </button>
      </div>
    </div>
  </div>
</div>

<!-- UPI payment sheet -->
<div id="upiPaymentSheet" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:100; padding:20px; overflow:auto;">
  <div style="max-width:800px; margin:40px auto; background:#1a2230; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0; font-size:24px;">Pay via UPI</h2>
      <button onclick="document.getElementById('upiPaymentSheet').style.display='none';" style="background:none; border:1px solid #3a4555; border-radius:8px; padding:8px 12px; color:white; cursor:pointer;">Close</button>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
      <div>
        <div class="muted">Scan with any UPI app like Google Pay, PhonePe, Paytm, or BHIM.</div>
        <div style="margin-top:8px"><code>demobarber@upi</code></div>
        <div style="margin-top:16px">
          <a href="upi://pay?pa=demobarber@upi" target="_blank" rel="noopener" class="btn primary" style="margin-right:10px;">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
            Open
          </a>
          <button onclick="navigator.clipboard.writeText('demobarber@upi');" class="btn">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
            </svg>
            Copy
          </button>
        </div>
      </div>
      <div style="display:flex; flex-direction:column; align-items:center;">
        <div id="upi-qr-container" style="width:220px; height:220px; background:#fff; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
          <!-- Pre-generated QR code image -->
          <img src="data:image/png;base64,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" alt="UPI QR Code" style="width:100%; height:100%;">
        </div>
        <button onclick="alert('QR code download not implemented yet');" class="btn small" style="margin-top:10px;">
          <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Download QR
        </button>
      </div>
    </div>
  </div>
</div>

<!-- QR library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
(function(){
  // ---------- URL / state ----------
  const $ = (id) => document.getElementById(id);
  const S = { profile:null, rails:[], region:'', qs:new URLSearchParams(location.search) };

  // Redirect to demo if no ?u
  if (!S.qs.get('u')) {
    const u = new URL(location.href);
    u.searchParams.set('u','demo');
    location.replace(u.toString());
  }

  // Inputs
  const amountEl = $('amount'), noteEl = $('note'), fiatEl = $('fiat');
  const chipsEl = $('chips');
  
  // Sheet elements
  const SHEET = $('sheet');
  const SHEET_TITLE = $('sheetTitle');
  const SHEET_BODY = $('sheetBody');

  // Create utility: update URL (not reload) and re-render QR
  function currentUrl(){
    const url = new URL(location.href);
    // keep ?u, update amount/note/fiat
    const keep = new URLSearchParams();
    keep.set('u', S.qs.get('u'));
    const amt = amountEl.value.trim(); const n = noteEl.value.trim(); const f = fiatEl.value.trim().toUpperCase();
    if (amt) keep.set('amount', amt);
    if (n) keep.set('note', n);
    if (f) keep.set('fiat', f);
    url.search = keep.toString();
    return url.toString();
  }

  // Simple QR code generation using qrcode.js library
  window.generateQR = function(elementId, text) {
    try {
      console.log(`Generating QR code for element ${elementId} with text: ${text}`);
      const element = document.getElementById(elementId);
      if (!element) {
        console.error('Element not found:', elementId);
        return;
      }
      
      // Clear previous content
      element.innerHTML = '<div>Generating QR...</div>';
      
      // Use setTimeout to ensure the DOM is updated
      setTimeout(() => {
        try {
          // Clear again before generating
          element.innerHTML = '';
          
          // Generate QR code
          QRCode.toCanvas(element, text, {
            width: 220,
            margin: 0,
            color: {
              dark: '#000000',
              light: '#FFFFFF'
            }
          }, function(error) {
            if (error) {
              console.error('QR generation error:', error);
              element.innerHTML = '<div style="padding:10px;background:#fff;color:#000;text-align:center;">QR Error</div>';
            } else {
              console.log('QR code successfully generated for', elementId);
            }
          });
        } catch (innerError) {
          console.error('QR generation inner error:', innerError);
          element.innerHTML = '<div style="padding:10px;background:#fff;color:#000;text-align:center;">QR Error</div>';
        }
      }, 100);
    } catch (e) {
      console.error('QR generation error:', e);
      const element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = '<div style="padding:10px;background:#fff;color:#000;text-align:center;">QR Error</div>';
      }
    }
  }

  function setUniversalQr() {
    console.log("Setting universal QR code with URL:", currentUrl());
    try {
      const qrElement = document.getElementById('universalQr');
      if (!qrElement) {
        console.error("Universal QR element not found");
        return;
      }
      
      // Clear previous content
      qrElement.innerHTML = '<div>Generating QR...</div>';
      
      // Use setTimeout to ensure the DOM is updated
      setTimeout(() => {
        try {
          // Clear again before generating
          qrElement.innerHTML = '';
          
          // Generate QR code using the constructor approach
          new QRCode(qrElement, {
            text: currentUrl(),
            width: 220,
            height: 220,
            colorDark: '#000000',
            colorLight: '#FFFFFF',
            correctLevel: QRCode.CorrectLevel.H
          });
          
          console.log("Universal QR code successfully generated");
        } catch (innerError) {
          console.error("Error generating universal QR code:", innerError);
          qrElement.innerHTML = '<div style="padding:10px;background:#fff;color:#000;text-align:center;">QR Error</div>';
        }
      }, 100);
    } catch (e) {
      console.error("Universal QR code generation error:", e);
    }
  }

  // ---------- Rail builders ----------
  function cleanIban(s){ return String(s||'').replace(/\s+/g,'').toUpperCase(); }
  function limit(s,n){ const t=String(s||''); return t.length>n ? t.slice(0,n) : t; }

  // EPC SEPA
  function makeEpcSctQr({ name, iban, amount, remittance, bic='', version='002', charset='1'}){
    const ib = cleanIban(iban);
    if(!/^[A-Z]{2}\d{2}[A-Z0-9]{10,30}$/.test(ib)) throw new Error('Invalid IBAN');
    const payee=limit(name||'Payee',70);
    const amt=amount?`EUR${Number(amount).toFixed(2)}`:'';
    const rem=limit(remittance||'',140);
    return ['BCD',version,charset,'SCT',bic,payee,ib,amt,'','',rem].join('\n');
  }
  function makePayto({ iban, amount, remittance }){
    const ib=cleanIban(iban); const q=new URLSearchParams();
    if(amount) q.set('amount', Number(amount).toFixed(2));
    if(remittance) q.set('message', remittance);
    return `payto://iban/${ib}${q.toString()? '?'+q.toString():''}`;
  }

  // Swiss QR-bill (SPC 0200)
  function makeSwissQr({iban, creditorName, street, houseNo, postal, town, country='CH', amount, currency='CHF', message='', referenceType='NON', reference:''}){
    const IB=cleanIban(iban);
    if(!/^(CH|LI)[0-9A-Z]{19}$/.test(IB)) throw new Error('Swiss IBAN (CH/LI) required');
    const lines=[];
    lines.push('SPC','0200','1',IB);
    lines.push('S', limit(creditorName||'Payee',70), limit(street||'',70), limit(houseNo||'',16), limit(postal||'',16), limit(town||'',35), (country||'CH').toUpperCase());
    lines.push(amount?Number(amount).toFixed(2):'', (currency==='EUR'||currency==='CHF')?currency:'CHF');
    // Ultimate Debtor (empty)
    lines.push('','','','','','','');
    lines.push(referenceType||'NON', (referenceType==='NON'?'':(reference||'')));
    lines.push(limit(message||'',140));
    lines.push('EPD');
    return lines.join('\n');
  }

  // Pix EMV BR Code
  function emvKV(id,val){ const v=String(val); return id + String(v.length).padStart(2,'0') + v; }
  function crc16ccitt(str){ let crc=0xFFFF; for(let i=0;i<str.length;i++){ crc ^= (str.charCodeAt(i)<<8); for(let j=0;j<8;j++){ crc=(crc&0x8000)?((crc<<1)^0x1021):(crc<<1); crc&=0xFFFF; } } return crc.toString(16).toUpperCase().padStart(4,'0'); }
  function makePix({key,name,city,amount,note}){
    const base = [
      emvKV('00','01'),
      emvKV('01','12'),
      emvKV('26', [emvKV('00','br.gov.bcb.pix'), key?emvKV('01',key):'', note?emvKV('02', String(note).substring(0,25)):''].join('')),
      emvKV('52','0000'),
      emvKV('53','986'),
      amount?emvKV('54', Number(amount).toFixed(2)):'',
      emvKV('58','BR'),
      emvKV('59', String(name||'Payee').substring(0,25)),
      emvKV('60', String(city||'SAO PAULO').toUpperCase().substring(0,15)),
      emvKV('62', emvKV('05','***')),
      '6304'
    ].join('');
    return base + crc16ccitt(base);
  }

  // UPI deep link
  function makeUpi({pa,pn,amount,note}){ const q=new URLSearchParams(); q.set('pa',pa); q.set('pn',pn||'Payee'); if(amount) q.set('am', Number(amount).toFixed(2)); q.set('cu','INR'); if(note) q.set('tn',note); return `upi://pay?${q.toString()}`; }

  // Lightning / BTC / Solana
  function lnurlFromAddress(addr){ if(!addr||!addr.includes('@')) return null; const [u,d]=addr.split('@'); return `https://${d}/.well-known/lnurlp/${u}`; }
  function btcUri({address,amount,note}){ const q=new URLSearchParams(); if(amount) q.set('amount', Number(amount).toFixed(8)); if(note) q.set('label',note); return `bitcoin:${address}${q.toString()? '?'+q.toString():''}`; }
  function solUri({address, splTokenMint, amount}){ const q=new URLSearchParams(); if(amount) q.set('amount', Number(amount).toFixed(2)); if(splTokenMint) q.set('spl-token', splTokenMint); return `solana:${address}${q.toString()? '?'+q.toString():''}`; }

  // Consumer links
  const paypalUrl=(h,a,c)=>`https://paypal.me/${h}${a?'/'+Number(a)+(c?c.toUpperCase():''):''}`;
  const revolutUrl=(h)=>`https://revolut.me/${h}`;
  const cashUrl=(h,a)=>`https://cash.app/$${h}${a?'/'+Number(a):''}`;
  const venmoUrl=(u)=>`https://venmo.com/u/${u}`;

  // ---------- Render helpers ----------
  function svg(icon){
    // Lightweight inline icons
    if(icon==='bank') return '<svg viewBox="0 0 24 24" fill="none"><path d="M3 10h18M5 10v8m4-8v8m4-8v8m4-8v8M2 20h20M12 4l9 6H3l9-6Z" stroke="currentColor" stroke-width="1.4"/></svg>';
    if(icon==='ch') return '<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.4"/><path d="M12 7v10M7 12h10" stroke="currentColor" stroke-width="1.6"/></svg>';
    if(icon==='pix') return '<svg viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="16" rx="4" stroke="currentColor" stroke-width="1.4"/><path d="M8 12l4-4 4 4-4 4-4-4Z" stroke="currentColor" stroke-width="1.4"/></svg>';
    if(icon==='upi') return '<svg viewBox="0 0 24 24" fill="none"><path d="M4 12h16M12 4v16" stroke="currentColor" stroke-width="1.4"/></svg>';
    if(icon==='zap') return '<svg viewBox="0 0 24 24" fill="none"><path d="M13 2L3 14h7l-1 8 10-12h-7l1-8Z" stroke="currentColor" stroke-width="1.2"/></svg>';
    if(icon==='btc') return '<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.4"/><path d="M9 8h5a2 2 0 110 4H9h6a2 2 0 110 4H9m2-10v12" stroke="currentColor" stroke-width="1.2"/></svg>';
    if(icon==='sol') return '<svg viewBox="0 0 24 24" fill="none"><path d="M7 7h10l-3 3H4l3-3Zm0 7h10l-3 3H4l3-3Zm3-7h10l-3 3H7l3-3Z" stroke="currentColor" stroke-width="1.2"/></svg>';
    if(icon==='evm') return '<svg viewBox="0 0 24 24" fill="none"><path d="M12 2l6 10-6 10-6-10 6-10Zm0 6l3 4-3 2-3-2 3-4Z" stroke="currentColor" stroke-width="1.2"/></svg>';
    if(icon==='pay') return '<svg viewBox="0 0 24 24" fill="none"><path d="M3 7h18v10H3z" stroke="currentColor" stroke-width="1.4"/><path d="M3 10h18" stroke="currentColor" stroke-width="1.2"/></svg>';
    return '';
  }

  function railItem(kind, label, sub, icon){
    console.log(`Creating rail item: ${kind}, ${label}, ${sub}, ${icon}`);
    const div = document.createElement('div');
    div.className='rail';
    div.setAttribute('role', 'button');
    div.setAttribute('tabindex', '0');
    div.setAttribute('aria-label', `Pay with ${label}${sub ? ': ' + sub : ''}`);
    
    // Get the SVG icon
    const svgIcon = svg(icon);
    console.log(`SVG icon for ${icon}:`, svgIcon);
    
    div.innerHTML = `${svgIcon} <div><div>${label}</div><small>${sub||''}</small></div>`;
    div.onclick = ()=> openRail(kind);
    div.onkeydown = (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openRail(kind);
      }
    };
    return div;
  }

  function regionBoost(list){
    const reg = S.region;
    const score = {};
    const boost = (k,s)=>score[k]=(score[k]||0)+s;
    if (reg==='IN') boost('UPI',5);
    if (reg==='BR') boost('PIX',5);
    if (['DE','FR','IT','ES','NL','BE','PT','AT','FI','IE'].includes(reg)) boost('SEPA',4);
    if (['CH','LI'].includes(reg)) boost('SWISS',5);
    // defaults
    boost('Lightning',2); boost('BTC',1); boost('Solana',1);
    return list.sort((a,b)=> (score[b.kind]||0)-(score[a.kind]||0));
  }

  function pickPrimary(){
    const available = S.rails.map(r=>r.kind);
    const reg = S.region;
    const prefers = [
      (['CH','LI'].includes(reg) && available.includes('SWISS')) && 'SWISS',
      (['IN'].includes(reg) && available.includes('UPI')) && 'UPI',
      (['BR'].includes(reg) && available.includes('PIX')) && 'PIX',
      (available.includes('SEPA')) && 'SEPA',
      (available.includes('Lightning')) && 'Lightning',
      (available.includes('PayPal')) && 'PayPal',
      (available.includes('BTC')) && 'BTC'
    ].filter(Boolean);
    return prefers[0] || available[0] || null;
  }

  // ---------- Modal logic ----------
  const SHEET = $('sheet'), SHEET_TITLE = $('sheetTitle'), SHEET_BODY = $('sheetBody');
  $('closeSheet').onclick = ()=> SHEET.classList.remove('on');
  SHEET.addEventListener('click', e=>{ if(e.target===SHEET) SHEET.classList.remove('on'); });

  // Make openRail globally accessible
  // Define global variables for input elements
  const amountEl = document.getElementById('amount');
  const noteEl = document.getElementById('note');
  const fiatEl = document.getElementById('fiat');
  
  window.openRail = function(kind){
    console.log("Opening rail:", kind);
    const p = S.profile || {
      name: "Demo Barber",
      currency: "CHF",
      rails: {
        iban: "CH4431999123000889012",
        upi: "demobarber@upi",
        pix_key: "demobarber@example.com",
        lightning_address: "demo@lightningaddress.com",
        bitcoin_address: "bc1qexampleaddress0000000000000000000000k3",
        solana_address: "7gExaMpleSolAddre55base58goeshereABCDE12",
        solana_usdc_mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
        ethereum_address: "0xABCD1234ABCD1234ABCD1234ABCD1234ABCD1234",
        usdt_evm: "0x9999999999999999999999999999999999999999",
        paypal_me: "demobarber",
        revolut_me: "demobarber",
        cash_app: "demobarber",
        venmo: "demobarber",
        zelle: "demobarber@example.com",
        interac_email: "demo.ca@example.com",
        payid_au: "demo.au@example.com",
        fps_id: "1234-5678-ABCD"
      }
    };
    const r = p.rails || {};
    const amt = amountEl ? amountEl.value.trim() : ''; 
    const memo = noteEl ? noteEl.value.trim() : ''; 
    const ccy = ((fiatEl ? fiatEl.value.trim() : '') || p.currency || '').toUpperCase();
    const name = p.name || 'Payee';

    SHEET_TITLE.textContent = `Pay via ${kind}`;
    const left = document.createElement('div');
    const right = document.createElement('div');
    right.className='qrbox';
    const c = document.createElement('div'); c.className='qr'; right.appendChild(c);
    const dl = document.createElement('button'); 
    dl.className='btn small'; 
    dl.setAttribute('aria-label', 'Download QR code as PNG image');
    dl.innerHTML = `
      <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      Download QR
    `;
    right.appendChild(dl);

    let openHref = '#', copyText = '', note='';
    let qrPayload = null, infoHtml = '';

    if(kind==='SEPA'){
      const epc = makeEpcSctQr({ name, iban:r.iban, amount: (ccy==='EUR')?amt:undefined, remittance:memo });
      const pto = makePayto({ iban:r.iban, amount: (ccy==='EUR')?amt:undefined, remittance:memo });
      openHref=pto; qrPayload=epc; copyText=r.iban;
      infoHtml = `<div class="muted">Many EU bank apps scan this and pre‑fill. If available, pick <b>Instant</b> in your bank app. Same QR works for Instant.</div>
                  <div style="margin-top:8px"><code>${r.iban}</code></div>`;
    }
    if(kind==='SWISS'){
      const chCcy = (ccy==='CHF'||ccy==='EUR')?ccy:'CHF';
      const payload = makeSwissQr({
        iban:r.iban, creditorName:name,
        street:p.ch_street, houseNo:p.ch_house_no, postal:p.ch_postal, town:p.ch_city, country:p.ch_country||'CH',
        amount:amt, currency:chCcy, message:memo, referenceType:'NON'
      });
      qrPayload=payload; openHref='#'; copyText=r.iban;
      infoHtml = `<div class="muted">Swiss QR‑bill (SPC 0200). Works with Swiss e-/m‑banking.</div>
                  <div style="margin-top:8px"><code>${r.iban}</code></div>`;
    }
    if(kind==='UPI'){
      const url = makeUpi({ pa:r.upi, pn:name, amount:amt, note:memo });
      openHref=url; qrPayload=url; copyText=r.upi;
      infoHtml = `<div class="muted">Opens your UPI app. QR encodes the same UPI link for scanning.</div>
                  <div style="margin-top:8px"><code>${r.upi}</code></div>`;
    }
    if(kind==='PIX'){
      const payload = makePix({ key:r.pix_key, name:p.pix_name||name, city:p.pix_city||'SAO PAULO', amount:amt, note:memo });
      qrPayload=payload; openHref='#'; copyText=payload;
      infoHtml = `<div class="muted">Copy code or scan EMV BR Code in your bank app.</div>`;
    }
    if(kind==='Lightning'){
      const ln = r.lnurlp_url || lnurlFromAddress(r.lightning_address);
      openHref=ln; qrPayload=ln; copyText = r.lightning_address || ln;
      infoHtml = `<div class="muted">Lightning Address / LNURL‑Pay</div>`;
    }
    if(kind==='BTC'){
      const url = btcUri({ address:r.bitcoin_address, amount:amt? (Number(amt)/100000).toFixed(8):undefined, note:memo }); // optional: crude map if you put fiat
      openHref=url; qrPayload=url; copyText=r.bitcoin_address;
      infoHtml = `<div class="muted">Bitcoin on‑chain</div><div style="margin-top:8px"><code>${r.bitcoin_address}</code></div>`;
    }
    if(kind==='Solana'){
      const url = solUri({ address:r.solana_address, splTokenMint:r.solana_usdc_mint, amount:amt });
      openHref=url; qrPayload=url; copyText=r.solana_address;
      infoHtml = `<div class="muted">${r.solana_usdc_mint?'Solana Pay (USDC)':'Solana (SOL)'}</div><div style="margin-top:8px"><code>${r.solana_address}</code></div>`;
    }
    if(kind==='PayPal'){ openHref=paypalUrl(r.paypal_me, amt, ccy); copyText=openHref; infoHtml = `<div class="muted">PayPal.Me link</div>`; qrPayload=openHref; }
    if(kind==='Revolut'){ openHref=revolutUrl(r.revolut_me); copyText=openHref; infoHtml = `<div class="muted">Revolut payment link</div>`; qrPayload=openHref; }
    if(kind==='CashApp'){ openHref=cashUrl(r.cash_app, amt); copyText=openHref; infoHtml = `<div class="muted">Cash App link</div>`; qrPayload=openHref; }
    if(kind==='Venmo'){ openHref=venmoUrl(r.venmo); copyText=openHref; infoHtml = `<div class="muted">Venmo profile</div>`; qrPayload=openHref; }
    if(kind==='Zelle'){ openHref='#'; copyText=r.zelle; infoHtml = `<div class="muted">Use your bank/Zelle app and paste this ID:</div><div style="margin-top:8px"><code>${r.zelle}</code></div>`; }
    if(kind==='Interac'){ openHref='#'; copyText=r.interac_email; infoHtml = `<div class="muted">Send an Interac e‑Transfer to:</div><div style="margin-top:8px"><code>${r.interac_email}</code></div>`; }
    if(kind==='PayID'){ openHref='#'; copyText=r.payid_au; infoHtml = `<div class="muted">Use PayID (AU):</div><div style="margin-top:8px"><code>${r.payid_au}</code></div>`; }
    if(kind==='FPS'){ openHref='#'; copyText=r.fps_id; infoHtml = `<div class="muted">Use FPS (HK):</div><div style="margin-top:8px"><code>${r.fps_id}</code></div>`; }

    // left content
    left.innerHTML = `
      ${infoHtml}
      <div class="actions" style="margin-top:12px">
        <a class="btn primary" href="${openHref}" target="_blank" rel="noopener" aria-label="Open payment in app or browser">
          <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
          Open
        </a>
        <button id="copyRail" class="btn" aria-label="Copy payment details to clipboard">
          <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
          </svg>
          Copy
        </button>
      </div>
      <div class="note">Tip: If Open doesn't switch to your app, scan the QR on the right.</div>
    `;

    SHEET_BODY.innerHTML=''; SHEET_BODY.appendChild(left); SHEET_BODY.appendChild(right);

    // QR payload (only when we have one)
    if (qrPayload) {
      console.log("Creating QR code with payload:", qrPayload);
      
      // Create a unique ID for this QR code
      const qrId = 'qr-' + Math.random().toString(36).substring(2, 15);
      c.id = qrId;
      
      // Add a placeholder while QR code is being generated
      c.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#fff;color:#000;">Generating QR...</div>';
      
      // Use setTimeout to ensure the DOM is updated before generating QR
      setTimeout(() => {
        window.generateQR(qrId, qrPayload);
      }, 100);
      
      // Download QR code
      dl.onclick = () => {
        try {
          // Find the canvas inside the QR code container
          const canvas = c.querySelector('canvas');
          if (canvas) {
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `${kind.toLowerCase()}-qr.png`;
            a.click();
          } else {
            alert('Could not generate QR code for download');
          }
        } catch (e) {
          console.error('Error downloading QR code:', e);
          alert('Could not download QR code');
        }
      };
    } else {
      right.innerHTML = '<div class="note">No QR for this rail; use the Open button.</div>';
    }

    $('copyRail').onclick = ()=> navigator.clipboard.writeText(copyText||openHref||'');
    
    // Debug info
    console.log("Showing payment sheet for:", kind);
    
    // Try both the original sheet and the inline sheet
    try {
      // First try the original sheet
      SHEET.style.display = 'flex';
      SHEET.classList.add('on');
      
      // Also show the inline sheet as a fallback
      const inlineSheet = document.getElementById('inlinePaymentSheet');
      const inlineTitle = document.getElementById('inlineSheetTitle');
      const inlineContent = document.getElementById('inlineSheetContent');
      
      if (inlineSheet && inlineTitle && inlineContent) {
        inlineTitle.textContent = `Pay via ${kind}`;
        
        // Create content for inline sheet
        inlineContent.innerHTML = '';
        
        // Left side - info and buttons
        const leftSide = document.createElement('div');
        leftSide.innerHTML = `
          ${infoHtml}
          <div style="margin-top:16px">
            <a href="${openHref}" target="_blank" rel="noopener" class="btn primary" style="margin-right:10px;">
              <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
              Open
            </a>
            <button onclick="navigator.clipboard.writeText('${copyText||openHref||''}');" class="btn">
              <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
              </svg>
              Copy
            </button>
          </div>
          <div class="note" style="margin-top:12px">Tip: If Open doesn't switch to your app, scan the QR on the right.</div>
        `;
        inlineContent.appendChild(leftSide);
        
        // Right side - QR code
        const rightSide = document.createElement('div');
        rightSide.style.display = 'flex';
        rightSide.style.flexDirection = 'column';
        rightSide.style.alignItems = 'center';
        
        if (qrPayload) {
          const qrContainer = document.createElement('div');
          qrContainer.id = 'inline-qr-' + Math.random().toString(36).substring(2, 15);
          qrContainer.style.width = '220px';
          qrContainer.style.height = '220px';
          qrContainer.style.background = '#fff';
          qrContainer.style.borderRadius = '12px';
          qrContainer.style.display = 'flex';
          qrContainer.style.alignItems = 'center';
          qrContainer.style.justifyContent = 'center';
          qrContainer.innerHTML = '<div>Generating QR...</div>';
          
          rightSide.appendChild(qrContainer);
          
          // Download button
          const downloadBtn = document.createElement('button');
          downloadBtn.className = 'btn small';
          downloadBtn.style.marginTop = '10px';
          downloadBtn.innerHTML = `
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download QR
          `;
          rightSide.appendChild(downloadBtn);
          
          // Generate QR code after DOM is updated
          setTimeout(() => {
            window.generateQR(qrContainer.id, qrPayload);
          }, 100);
        } else {
          rightSide.innerHTML = '<div class="note">No QR for this rail; use the Open button.</div>';
        }
        
        inlineContent.appendChild(rightSide);
        inlineSheet.style.display = 'block';
      }
    } catch (e) {
      console.error("Error showing payment sheet:", e);
    }
  }

  // ---------- Build rails ----------
  function buildRails(){
    const p = S.profile, r = p.rails||{}, grid = $('rails'); grid.innerHTML='';
    S.rails = []; // reset

    function push(kind,label,sub,icon,cond){
      if(!cond) return;
      S.rails.push({kind,label,sub});
      return railItem(kind,label,sub,icon);
    }

    // Debug info
    console.log("Building rails with profile:", p);
    console.log("Rails data:", r);

    // Group 1: Bank rails
    const bankRails = document.createElement('div');
    bankRails.className = 'rail-section';
    bankRails.innerHTML = '<h3>Bank Transfer Options</h3>';
    grid.appendChild(bankRails);
    
    const bankGrid = document.createElement('div');
    bankGrid.className = 'railgrid';
    bankRails.appendChild(bankGrid);
    
    const bankItems = [
      push('SEPA','IBAN / SEPA', r.iban||'', 'bank', !!r.iban),
      push('SWISS','Swiss QR‑bill', (r.iban||'').startsWith('CH')|| (r.iban||'').startsWith('LI') ? 'CH/LI IBAN' : '', 'ch', !!(r.iban && ((r.iban||'').startsWith('CH')||(r.iban||'').startsWith('LI')) && (p.ch_city||p.ch_street))),
      push('UPI','UPI', r.upi||'', 'upi', !!r.upi),
      push('PIX','Pix', p.pix_name? (p.pix_name + (p.pix_city?' · '+p.pix_city:'')) : '', 'pix', !!r.pix_key)
    ].filter(Boolean);
    
    console.log("Bank items:", bankItems);
    
    if (bankItems.length > 0) {
      bankItems.forEach(item => bankGrid.appendChild(item));
    } else {
      bankRails.style.display = 'none';
    }
    
    // Group 2: Crypto
    const cryptoRails = document.createElement('div');
    cryptoRails.className = 'rail-section';
    cryptoRails.innerHTML = '<h3>Cryptocurrency Options</h3>';
    grid.appendChild(cryptoRails);
    
    const cryptoGrid = document.createElement('div');
    cryptoGrid.className = 'railgrid';
    cryptoRails.appendChild(cryptoGrid);
    
    const cryptoItems = [
      push('Lightning','⚡ Lightning', r.lightning_address||r.lnurlp_url||'', 'zap', !!(r.lnurlp_url||r.lightning_address)),
      push('BTC','Bitcoin', r.bitcoin_address||'', 'btc', !!r.bitcoin_address),
      push('Solana','Solana', r.solana_usdc_mint? 'Solana Pay (USDC)' : (r.solana_address? 'Solana (SOL)':''), 'sol', !!r.solana_address)
    ].filter(Boolean);
    
    console.log("Crypto items:", cryptoItems);
    
    if (cryptoItems.length > 0) {
      cryptoItems.forEach(item => cryptoGrid.appendChild(item));
    } else {
      cryptoRails.style.display = 'none';
    }
    
    // Group 3: Wallet links
    const walletRails = document.createElement('div');
    walletRails.className = 'rail-section';
    walletRails.innerHTML = '<h3>Payment Apps & Services</h3>';
    grid.appendChild(walletRails);
    
    const walletGrid = document.createElement('div');
    walletGrid.className = 'railgrid';
    walletRails.appendChild(walletGrid);
    
    const walletItems = [
      push('PayPal','PayPal.Me', r.paypal_me||'', 'pay', !!r.paypal_me),
      push('Revolut','Revolut.me', r.revolut_me||'', 'pay', !!r.revolut_me),
      push('CashApp','Cash App', r.cash_app? ('$'+r.cash_app):'', 'pay', !!r.cash_app),
      push('Venmo','Venmo', r.venmo?('@'+r.venmo):'', 'pay', !!r.venmo),
      push('Zelle','Zelle', r.zelle||'', 'pay', !!r.zelle),
      push('Interac','Interac e‑Transfer', r.interac_email||'', 'pay', !!r.interac_email),
      push('PayID','PayID (AU)', r.payid_au||'', 'pay', !!r.payid_au),
      push('FPS','FPS (HK)', r.fps_id||'', 'pay', !!r.fps_id)
    ].filter(Boolean);
    
    console.log("Wallet items:", walletItems);
    
    if (walletItems.length > 0) {
      walletItems.forEach(item => walletGrid.appendChild(item));
    } else {
      walletRails.style.display = 'none';
    }

    // Primary CTA
    const primary = pickPrimary();
    const btn = $('primaryCta');
    if (primary){ btn.textContent = `Pay with ${primary}`; btn.onclick = (e)=>{ e.preventDefault(); openRail(primary); }; btn.href='#'; }
    else { btn.textContent='Choose a rail'; btn.onclick = null; btn.href='#rails'; }
  }

  // ---------- Boot ----------
  (function boot(){
    // region
    try {
      S.region = (Intl.DateTimeFormat().resolvedOptions().locale || '').split('-')[1] || '';
    } catch(_) { S.region=''; }

    // hydrate inputs from URL
    amountEl.value = S.qs.get('amount') || '';
    noteEl.value = S.qs.get('note') || '';
    fiatEl.value = (S.qs.get('fiat') || '').toUpperCase();

    // amount chips (contextual)
    const chipVals = ['5','10','20','35','50','100'];
    chipsEl.innerHTML = chipVals.map(v=>`<button class="chip" data-v="${v}" aria-label="Set amount to ${v}">${v}</button>`).join('');
    chipsEl.querySelectorAll('.chip').forEach(b => {
      b.onclick = ()=>{ 
        amountEl.value=b.dataset.v; 
        onInputsChanged(); 
        // Provide visual feedback
        b.style.backgroundColor = '#1a2d3a';
        b.style.borderColor = '#3a5269';
        setTimeout(() => {
          b.style.backgroundColor = '';
          b.style.borderColor = '';
        }, 300);
      };
    });

    // events
    amountEl.oninput = onInputsChanged;
    noteEl.oninput = onInputsChanged;
    fiatEl.oninput = onInputsChanged;

    // universal actions
    $('copylink').onclick = ()=> navigator.clipboard.writeText(currentUrl());
    $('share').onclick = async ()=> { if(navigator.share){ try{ await navigator.share({ title: document.title, text: 'Pay via any rail', url: currentUrl() });}catch(e){} } else { await navigator.clipboard.writeText(currentUrl()); alert('link copied'); } };

    // fetch profile
    const profileUrl = `${location.origin}${location.pathname.replace(/index\.html?$/,'')}profiles/${encodeURIComponent(S.qs.get('u'))}.json`;
    console.log("Fetching profile from:", profileUrl);
    
    fetch(profileUrl)
      .then(r => {
        if (!r.ok) {
          console.error("Profile fetch failed:", r.status, r.statusText);
          return Promise.reject(new Error('profile not found'));
        }
        return r.json();
      })
      .then(p => {
        console.log("Profile loaded successfully:", p);
        S.profile = p;
        $('title').textContent = (p.name? `${p.name} — Pay` : 'Pay');
        $('subtitle').textContent = 'One QR, any money.';
        if (p.avatar) { $('avatar').src = p.avatar; } else { $('avatar').style.display='none'; }
        const tags = []; if (p.city) tags.push(`<span class="tag">${p.city}</span>`); if (p.category) tags.push(`<span class="tag">${p.category}</span>`);
        $('meta').innerHTML = tags.join(' ');
        buildRails();
        setUniversalQr();
      })
      .catch(err => {
        console.error("Profile loading error:", err);
        $('title').textContent='UPL'; $('subtitle').textContent='One QR, any money.';
        $('rails').innerHTML = '<div class="muted">No profile found. <a href="make.html">Create your profile</a>.</div>';
        setUniversalQr();
      });
  })();

  function onInputsChanged(){ setUniversalQr(); }
  
  // ---------- Direct payment methods ----------
  window.showSepaPayment = function() {
    alert("Showing SEPA payment sheet");
    console.log("Showing SEPA payment sheet");
    
    // Get the inline payment sheet elements
    const inlineSheet = document.getElementById('inlinePaymentSheet');
    const inlineTitle = document.getElementById('inlineSheetTitle');
    const inlineContent = document.getElementById('inlineSheetContent');
    
    if (!inlineSheet || !inlineTitle || !inlineContent) {
      console.error("Could not find inline payment sheet elements");
      alert("Payment sheet could not be displayed. Please try again.");
      return;
    }
    
    // Set the title
    inlineTitle.textContent = 'Pay via IBAN / SEPA';
    
    // Create content for inline sheet
    inlineContent.innerHTML = `
      <div>
        <div class='muted'>Many EU bank apps scan this and pre‑fill. If available, pick <b>Instant</b> in your bank app. Same QR works for Instant.</div>
        <div style='margin-top:8px'><code>CH4431999123000889012</code></div>
        <div style='margin-top:16px'>
          <a href='#' target='_blank' rel='noopener' class='btn primary' style='margin-right:10px;'>
            <svg aria-hidden='true' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
              <path d='M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6'></path>
              <polyline points='15 3 21 3 21 9'></polyline>
              <line x1='10' y1='14' x2='21' y2='3'></line>
            </svg>
            Open
          </a>
          <button onclick='navigator.clipboard.writeText("CH4431999123000889012");' class='btn'>
            <svg aria-hidden='true' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
              <rect x='9' y='9' width='13' height='13' rx='2' ry='2'></rect>
              <path d='M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1'></path>
            </svg>
            Copy
          </button>
        </div>
      </div>
      <div style='display:flex;flex-direction:column;align-items:center;'>
        <div id='direct-qr-sepa' style='width:220px;height:220px;background:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;'>
          <div>Generating QR...</div>
        </div>
        <button class='btn small' style='margin-top:10px;'>
          <svg aria-hidden='true' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
            <path d='M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4'></path>
            <polyline points='7 10 12 15 17 10'></polyline>
            <line x1='12' y1='15' x2='12' y2='3'></line>
          </svg>
          Download QR
        </button>
      </div>
    `;
    
    // Show the sheet
    inlineSheet.style.display = 'block';
    
    // Generate QR code
    setTimeout(() => {
      try {
        window.generateQR('direct-qr-sepa', 'CH4431999123000889012');
      } catch (e) {
        console.error("Error generating QR code:", e);
        document.getElementById('direct-qr-sepa').innerHTML = '<div>Error generating QR code</div>';
      }
    }, 100);
  };
})();
</script>

<!-- Optional Cloudflare Analytics
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token":"YOUR_TOKEN"}'></script>
-->
</body>
</html>