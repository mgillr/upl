<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Universal Pay Link</title>
<meta name="description" content="One QR, any money. Bank & instant rails, Swiss QR-bill, UPI, Pix, Lightning, BTC, Solana, PayPal/Revolut, and more.">

<style>
  :root{
    --bg:#0b0c10; --surface:#10141a; --surface2:#0f1318;
    --border:#222a35; --text:#e7e9ea; --muted:#9aa4b2;
    --accent:#22d3ee; --accent2:#7dd3fc; --radius:16px; --maxw:980px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:
      radial-gradient(1200px 600px at 20% -10%, rgba(34,211,238,.08), transparent 50%),
      radial-gradient(1200px 600px at 100% 10%, rgba(125,211,252,.08), transparent 40%),
      var(--bg);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    line-height:1.45;
  }
  a{color:#b7d3ff; text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:var(--maxw); margin:0 auto; padding:20px}
  header{display:flex; align-items:center; gap:16px; margin:6px 0 16px}
  header img{width:56px; height:56px; border-radius:50%; object-fit:cover; background:#1a1f28; border:1px solid var(--border)}
  h1{font-size:22px; margin:0}
  .muted{color:var(--muted)}
  .tag{display:inline-block; border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; margin-right:8px; color:var(--muted)}

  .card{background:linear-gradient(180deg,var(--surface),var(--surface2)); border:1px solid var(--border); border-radius:var(--radius); padding:18px; margin:12px 0; box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .col{flex:1 1 360px}

  .hero{display:grid; grid-template-columns: 220px 1fr; gap:18px; align-items:center}
  @media (max-width:820px){ .hero{grid-template-columns:1fr} }

  .qr{background:#fff; border-radius:12px; width:220px; height:220px; display:flex; align-items:center; justify-content:center}

  .input{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px}
  .txt{flex:1 1 160px; min-width:160px; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#0f131a; color:var(--text)}
  .chipbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .chip{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#141a22; cursor:pointer}
  .chip:hover{border-color:#2e3846}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:12px 16px; border:1px solid var(--border); border-radius:12px; background:#141a22; color:var(--text); text-decoration:none; cursor:pointer; transition:transform .08s ease, border-color .2s ease}
  .btn:hover{transform:translateY(-1px); border-color:#2e3846}
  .btn.primary{background:linear-gradient(180deg,#14232c,#111820); border-color:#294050}
  .btn.small{padding:8px 10px; font-size:12px}

  .railgrid{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
  @media (max-width:820px){ .railgrid{grid-template-columns: repeat(2, 1fr)} }
  .rail{display:flex; align-items:center; gap:10px; border:1px solid var(--border); border-radius:12px; background:#141a22; padding:12px; cursor:pointer}
  .rail:hover{border-color:#2e3846}
  .rail svg{width:20px; height:20px}
  .rail small{color:var(--muted)}

  footer{opacity:.7; font-size:12px; margin:28px 0; text-align:center}

  /* Modal sheet */
  .sheet{position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; background:rgba(0,0,0,.45); z-index:50}
  .sheet.on{display:flex}
  .sheet .panel{background:linear-gradient(180deg,var(--surface),var(--surface2)); border:1px solid var(--border); border-radius:18px 18px 0 0; padding:18px; width:min(720px,100%); max-height:85vh; overflow:auto}
  .sheet .head{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
  .sheet .title{font-weight:600}
  .sheet .grid2{display:grid; grid-template-columns:1fr 220px; gap:16px}
  @media (max-width:760px){ .sheet .grid2{grid-template-columns:1fr} }
  .qrbox{display:flex; flex-direction:column; align-items:center; gap:8px}
  .qrbox .qr{background:#fff; border-radius:12px; width:220px; height:220px}
  .note{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <img id="avatar" alt="">
    <div>
      <h1 id="title">Universal Pay Link</h1>
      <div class="muted" id="subtitle">One QR, any money.</div>
      <div id="meta"></div>
    </div>
  </header>

  <!-- HERO: ONE universal QR -->
  <div class="card">
    <div class="hero">
      <div style="display:flex; flex-direction:column; align-items:center; gap:10px">
        <div id="universalQr" class="qr"></div>
        <div class="actions">
          <button class="btn small" id="copylink">copy link</button>
          <button class="btn small" id="share">share</button>
        </div>
      </div>

      <div>
        <div class="muted">Set amount / note (optional). The QR updates live.</div>
        <div class="input">
          <input id="amount" class="txt" inputmode="decimal" placeholder="Amount (e.g., 35)">
          <input id="note" class="txt" maxlength="80" placeholder="Note (e.g., haircut)">
          <input id="fiat" class="txt" maxlength="4" placeholder="Currency (CHF, EUR, USD)">
        </div>
        <div class="chipbar" id="chips"></div>
        <div class="actions" style="margin-top:14px">
          <a id="primaryCta" class="btn primary" href="#" target="_blank" rel="noopener">Pay</a>
          <a class="btn" href="#rails">More options ↓</a>
        </div>
      </div>
    </div>
  </div>

  <!-- RAILS -->
  <div id="railsCard" class="card">
    <div class="muted" style="margin-bottom:8px">Choose a rail</div>
    <div id="rails" class="railgrid"></div>
  </div>

  <footer>
    Open source. Non‑custodial routing. Host on GitHub Pages. — <a href="make.html">Make your UPL</a>
  </footer>
</div>

<!-- Modal sheet -->
<div id="sheet" class="sheet" role="dialog" aria-modal="true">
  <div class="panel">
    <div class="head">
      <div class="title" id="sheetTitle">Pay</div>
      <button id="closeSheet" class="btn small">close</button>
    </div>
    <div id="sheetBody" class="grid2">
      <!-- left: info + buttons; right: QR -->
    </div>
  </div>
</div>

<!-- QR library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
(function(){
  // ---------- URL / state ----------
  const $ = (id) => document.getElementById(id);
  const S = { profile:null, rails:[], region:'', qs:new URLSearchParams(location.search) };

  // Redirect to demo if no ?u
  if (!S.qs.get('u')) {
    const u = new URL(location.href);
    u.searchParams.set('u','demo');
    location.replace(u.toString());
  }

  // Inputs
  const amountEl = $('amount'), noteEl = $('note'), fiatEl = $('fiat');
  const chipsEl = $('chips');

  // Create utility: update URL (not reload) and re-render QR
  function currentUrl(){
    const url = new URL(location.href);
    // keep ?u, update amount/note/fiat
    const keep = new URLSearchParams();
    keep.set('u', S.qs.get('u'));
    const amt = amountEl.value.trim(); const n = noteEl.value.trim(); const f = fiatEl.value.trim().toUpperCase();
    if (amt) keep.set('amount', amt);
    if (n) keep.set('note', n);
    if (f) keep.set('fiat', f);
    url.search = keep.toString();
    return url.toString();
  }

  // Simple QR code generation using qrcode.js library
  function generateQR(elementId, text) {
    try {
      const element = document.getElementById(elementId);
      if (!element) {
        console.error('Element not found:', elementId);
        return;
      }
      
      // Clear previous content
      element.innerHTML = '';
      
      // Generate QR code
      QRCode.toCanvas(element, text, {
        width: 200,
        margin: 1,
        color: {
          dark: '#000000',
          light: '#FFFFFF'
        }
      }, function(error) {
        if (error) {
          console.error('QR generation error:', error);
          element.innerHTML = '<div style="padding:10px;background:#fff;color:#000;text-align:center;">QR Error</div>';
        }
      });
      
      console.log('QR code generated for', elementId);
    } catch (e) {
      console.error('QR generation error:', e);
      const element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = '<div style="padding:10px;background:#fff;color:#000;text-align:center;">QR Error</div>';
      }
    }
  }

  function setUniversalQr() {
    generateQR('universalQr', currentUrl());
  }

  // ---------- Rail builders ----------
  function cleanIban(s){ return String(s||'').replace(/\s+/g,'').toUpperCase(); }
  function limit(s,n){ const t=String(s||''); return t.length>n ? t.slice(0,n) : t; }

  // EPC SEPA
  function makeEpcSctQr({ name, iban, amount, remittance, bic='', version='002', charset='1'}){
    const ib = cleanIban(iban);
    if(!/^[A-Z]{2}\d{2}[A-Z0-9]{10,30}$/.test(ib)) throw new Error('Invalid IBAN');
    const payee=limit(name||'Payee',70);
    const amt=amount?`EUR${Number(amount).toFixed(2)}`:'';
    const rem=limit(remittance||'',140);
    return ['BCD',version,charset,'SCT',bic,payee,ib,amt,'','',rem].join('\n');
  }
  function makePayto({ iban, amount, remittance }){
    const ib=cleanIban(iban); const q=new URLSearchParams();
    if(amount) q.set('amount', Number(amount).toFixed(2));
    if(remittance) q.set('message', remittance);
    return `payto://iban/${ib}${q.toString()? '?'+q.toString():''}`;
  }

  // Swiss QR-bill (SPC 0200)
  function makeSwissQr({iban, creditorName, street, houseNo, postal, town, country='CH', amount, currency='CHF', message='', referenceType='NON', reference:''}){
    const IB=cleanIban(iban);
    if(!/^(CH|LI)[0-9A-Z]{19}$/.test(IB)) throw new Error('Swiss IBAN (CH/LI) required');
    const lines=[];
    lines.push('SPC','0200','1',IB);
    lines.push('S', limit(creditorName||'Payee',70), limit(street||'',70), limit(houseNo||'',16), limit(postal||'',16), limit(town||'',35), (country||'CH').toUpperCase());
    lines.push(amount?Number(amount).toFixed(2):'', (currency==='EUR'||currency==='CHF')?currency:'CHF');
    // Ultimate Debtor (empty)
    lines.push('','','','','','','');
    lines.push(referenceType||'NON', (referenceType==='NON'?'':(reference||'')));
    lines.push(limit(message||'',140));
    lines.push('EPD');
    return lines.join('\n');
  }

  // Pix EMV BR Code
  function emvKV(id,val){ const v=String(val); return id + String(v.length).padStart(2,'0') + v; }
  function crc16ccitt(str){ let crc=0xFFFF; for(let i=0;i<str.length;i++){ crc ^= (str.charCodeAt(i)<<8); for(let j=0;j<8;j++){ crc=(crc&0x8000)?((crc<<1)^0x1021):(crc<<1); crc&=0xFFFF; } } return crc.toString(16).toUpperCase().padStart(4,'0'); }
  function makePix({key,name,city,amount,note}){
    const base = [
      emvKV('00','01'),
      emvKV('01','12'),
      emvKV('26', [emvKV('00','br.gov.bcb.pix'), key?emvKV('01',key):'', note?emvKV('02', String(note).substring(0,25)):''].join('')),
      emvKV('52','0000'),
      emvKV('53','986'),
      amount?emvKV('54', Number(amount).toFixed(2)):'',
      emvKV('58','BR'),
      emvKV('59', String(name||'Payee').substring(0,25)),
      emvKV('60', String(city||'SAO PAULO').toUpperCase().substring(0,15)),
      emvKV('62', emvKV('05','***')),
      '6304'
    ].join('');
    return base + crc16ccitt(base);
  }

  // UPI deep link
  function makeUpi({pa,pn,amount,note}){ const q=new URLSearchParams(); q.set('pa',pa); q.set('pn',pn||'Payee'); if(amount) q.set('am', Number(amount).toFixed(2)); q.set('cu','INR'); if(note) q.set('tn',note); return `upi://pay?${q.toString()}`; }

  // Lightning / BTC / Solana
  function lnurlFromAddress(addr){ if(!addr||!addr.includes('@')) return null; const [u,d]=addr.split('@'); return `https://${d}/.well-known/lnurlp/${u}`; }
  function btcUri({address,amount,note}){ const q=new URLSearchParams(); if(amount) q.set('amount', Number(amount).toFixed(8)); if(note) q.set('label',note); return `bitcoin:${address}${q.toString()? '?'+q.toString():''}`; }
  function solUri({address, splTokenMint, amount}){ const q=new URLSearchParams(); if(amount) q.set('amount', Number(amount).toFixed(2)); if(splTokenMint) q.set('spl-token', splTokenMint); return `solana:${address}${q.toString()? '?'+q.toString():''}`; }

  // Consumer links
  const paypalUrl=(h,a,c)=>`https://paypal.me/${h}${a?'/'+Number(a)+(c?c.toUpperCase():''):''}`;
  const revolutUrl=(h)=>`https://revolut.me/${h}`;
  const cashUrl=(h,a)=>`https://cash.app/$${h}${a?'/'+Number(a):''}`;
  const venmoUrl=(u)=>`https://venmo.com/u/${u}`;

  // ---------- Render helpers ----------
  function svg(icon){
    // Lightweight inline icons
    if(icon==='bank') return '<svg viewBox="0 0 24 24" fill="none"><path d="M3 10h18M5 10v8m4-8v8m4-8v8m4-8v8M2 20h20M12 4l9 6H3l9-6Z" stroke="currentColor" stroke-width="1.4"/></svg>';
    if(icon==='ch') return '<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.4"/><path d="M12 7v10M7 12h10" stroke="currentColor" stroke-width="1.6"/></svg>';
    if(icon==='pix') return '<svg viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="16" rx="4" stroke="currentColor" stroke-width="1.4"/><path d="M8 12l4-4 4 4-4 4-4-4Z" stroke="currentColor" stroke-width="1.4"/></svg>';
    if(icon==='upi') return '<svg viewBox="0 0 24 24" fill="none"><path d="M4 12h16M12 4v16" stroke="currentColor" stroke-width="1.4"/></svg>';
    if(icon==='zap') return '<svg viewBox="0 0 24 24" fill="none"><path d="M13 2L3 14h7l-1 8 10-12h-7l1-8Z" stroke="currentColor" stroke-width="1.2"/></svg>';
    if(icon==='btc') return '<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.4"/><path d="M9 8h5a2 2 0 110 4H9h6a2 2 0 110 4H9m2-10v12" stroke="currentColor" stroke-width="1.2"/></svg>';
    if(icon==='sol') return '<svg viewBox="0 0 24 24" fill="none"><path d="M7 7h10l-3 3H4l3-3Zm0 7h10l-3 3H4l3-3Zm3-7h10l-3 3H7l3-3Z" stroke="currentColor" stroke-width="1.2"/></svg>';
    if(icon==='evm') return '<svg viewBox="0 0 24 24" fill="none"><path d="M12 2l6 10-6 10-6-10 6-10Zm0 6l3 4-3 2-3-2 3-4Z" stroke="currentColor" stroke-width="1.2"/></svg>';
    if(icon==='pay') return '<svg viewBox="0 0 24 24" fill="none"><path d="M3 7h18v10H3z" stroke="currentColor" stroke-width="1.4"/><path d="M3 10h18" stroke="currentColor" stroke-width="1.2"/></svg>';
    return '';
  }

  function railItem(kind, label, sub, icon){
    const div = document.createElement('div');
    div.className='rail'; div.innerHTML = `${svg(icon)} <div><div>${label}</div><small>${sub||''}</small></div>`;
    div.onclick = ()=> openRail(kind);
    return div;
  }

  function regionBoost(list){
    const reg = S.region;
    const score = {};
    const boost = (k,s)=>score[k]=(score[k]||0)+s;
    if (reg==='IN') boost('UPI',5);
    if (reg==='BR') boost('PIX',5);
    if (['DE','FR','IT','ES','NL','BE','PT','AT','FI','IE'].includes(reg)) boost('SEPA',4);
    if (['CH','LI'].includes(reg)) boost('SWISS',5);
    // defaults
    boost('Lightning',2); boost('BTC',1); boost('Solana',1);
    return list.sort((a,b)=> (score[b.kind]||0)-(score[a.kind]||0));
  }

  function pickPrimary(){
    const available = S.rails.map(r=>r.kind);
    const reg = S.region;
    const prefers = [
      (['CH','LI'].includes(reg) && available.includes('SWISS')) && 'SWISS',
      (['IN'].includes(reg) && available.includes('UPI')) && 'UPI',
      (['BR'].includes(reg) && available.includes('PIX')) && 'PIX',
      (available.includes('SEPA')) && 'SEPA',
      (available.includes('Lightning')) && 'Lightning',
      (available.includes('PayPal')) && 'PayPal',
      (available.includes('BTC')) && 'BTC'
    ].filter(Boolean);
    return prefers[0] || available[0] || null;
  }

  // ---------- Modal logic ----------
  const SHEET = $('sheet'), SHEET_TITLE = $('sheetTitle'), SHEET_BODY = $('sheetBody');
  $('closeSheet').onclick = ()=> SHEET.classList.remove('on');
  SHEET.addEventListener('click', e=>{ if(e.target===SHEET) SHEET.classList.remove('on'); });

  function openRail(kind){
    const p = S.profile, r = p.rails || {};
    const amt = amountEl.value.trim(); const memo = noteEl.value.trim(); const ccy = (fiatEl.value.trim() || p.currency || '').toUpperCase();
    const name = p.name || 'Payee';

    SHEET_TITLE.textContent = `Pay via ${kind}`;
    const left = document.createElement('div');
    const right = document.createElement('div');
    right.className='qrbox';
    const c = document.createElement('div'); c.className='qr'; right.appendChild(c);
    const dl = document.createElement('button'); dl.className='btn small'; dl.textContent='download QR (PNG)'; right.appendChild(dl);

    let openHref = '#', copyText = '', note='';
    let qrPayload = null, infoHtml = '';

    if(kind==='SEPA'){
      const epc = makeEpcSctQr({ name, iban:r.iban, amount: (ccy==='EUR')?amt:undefined, remittance:memo });
      const pto = makePayto({ iban:r.iban, amount: (ccy==='EUR')?amt:undefined, remittance:memo });
      openHref=pto; qrPayload=epc; copyText=r.iban;
      infoHtml = `<div class="muted">Many EU bank apps scan this and pre‑fill. If available, pick <b>Instant</b> in your bank app. Same QR works for Instant.</div>
                  <div style="margin-top:8px"><code>${r.iban}</code></div>`;
    }
    if(kind==='SWISS'){
      const chCcy = (ccy==='CHF'||ccy==='EUR')?ccy:'CHF';
      const payload = makeSwissQr({
        iban:r.iban, creditorName:name,
        street:p.ch_street, houseNo:p.ch_house_no, postal:p.ch_postal, town:p.ch_city, country:p.ch_country||'CH',
        amount:amt, currency:chCcy, message:memo, referenceType:'NON'
      });
      qrPayload=payload; openHref='#'; copyText=r.iban;
      infoHtml = `<div class="muted">Swiss QR‑bill (SPC 0200). Works with Swiss e-/m‑banking.</div>
                  <div style="margin-top:8px"><code>${r.iban}</code></div>`;
    }
    if(kind==='UPI'){
      const url = makeUpi({ pa:r.upi, pn:name, amount:amt, note:memo });
      openHref=url; qrPayload=url; copyText=r.upi;
      infoHtml = `<div class="muted">Opens your UPI app. QR encodes the same UPI link for scanning.</div>
                  <div style="margin-top:8px"><code>${r.upi}</code></div>`;
    }
    if(kind==='PIX'){
      const payload = makePix({ key:r.pix_key, name:p.pix_name||name, city:p.pix_city||'SAO PAULO', amount:amt, note:memo });
      qrPayload=payload; openHref='#'; copyText=payload;
      infoHtml = `<div class="muted">Copy code or scan EMV BR Code in your bank app.</div>`;
    }
    if(kind==='Lightning'){
      const ln = r.lnurlp_url || lnurlFromAddress(r.lightning_address);
      openHref=ln; qrPayload=ln; copyText = r.lightning_address || ln;
      infoHtml = `<div class="muted">Lightning Address / LNURL‑Pay</div>`;
    }
    if(kind==='BTC'){
      const url = btcUri({ address:r.bitcoin_address, amount:amt? (Number(amt)/100000).toFixed(8):undefined, note:memo }); // optional: crude map if you put fiat
      openHref=url; qrPayload=url; copyText=r.bitcoin_address;
      infoHtml = `<div class="muted">Bitcoin on‑chain</div><div style="margin-top:8px"><code>${r.bitcoin_address}</code></div>`;
    }
    if(kind==='Solana'){
      const url = solUri({ address:r.solana_address, splTokenMint:r.solana_usdc_mint, amount:amt });
      openHref=url; qrPayload=url; copyText=r.solana_address;
      infoHtml = `<div class="muted">${r.solana_usdc_mint?'Solana Pay (USDC)':'Solana (SOL)'}</div><div style="margin-top:8px"><code>${r.solana_address}</code></div>`;
    }
    if(kind==='PayPal'){ openHref=paypalUrl(r.paypal_me, amt, ccy); copyText=openHref; infoHtml = `<div class="muted">PayPal.Me link</div>`; qrPayload=openHref; }
    if(kind==='Revolut'){ openHref=revolutUrl(r.revolut_me); copyText=openHref; infoHtml = `<div class="muted">Revolut payment link</div>`; qrPayload=openHref; }
    if(kind==='CashApp'){ openHref=cashUrl(r.cash_app, amt); copyText=openHref; infoHtml = `<div class="muted">Cash App link</div>`; qrPayload=openHref; }
    if(kind==='Venmo'){ openHref=venmoUrl(r.venmo); copyText=openHref; infoHtml = `<div class="muted">Venmo profile</div>`; qrPayload=openHref; }
    if(kind==='Zelle'){ openHref='#'; copyText=r.zelle; infoHtml = `<div class="muted">Use your bank/Zelle app and paste this ID:</div><div style="margin-top:8px"><code>${r.zelle}</code></div>`; }
    if(kind==='Interac'){ openHref='#'; copyText=r.interac_email; infoHtml = `<div class="muted">Send an Interac e‑Transfer to:</div><div style="margin-top:8px"><code>${r.interac_email}</code></div>`; }
    if(kind==='PayID'){ openHref='#'; copyText=r.payid_au; infoHtml = `<div class="muted">Use PayID (AU):</div><div style="margin-top:8px"><code>${r.payid_au}</code></div>`; }
    if(kind==='FPS'){ openHref='#'; copyText=r.fps_id; infoHtml = `<div class="muted">Use FPS (HK):</div><div style="margin-top:8px"><code>${r.fps_id}</code></div>`; }

    // left content
    left.innerHTML = `
      ${infoHtml}
      <div class="actions" style="margin-top:12px">
        <a class="btn primary" href="${openHref}" target="_blank" rel="noopener">Open</a>
        <button id="copyRail" class="btn">copy</button>
      </div>
      <div class="note">Tip: If Open doesn't switch to your app, scan the QR on the right.</div>
    `;

    SHEET_BODY.innerHTML=''; SHEET_BODY.appendChild(left); SHEET_BODY.appendChild(right);

    // QR payload (only when we have one)
    if (qrPayload) {
      // Create a unique ID for this QR code
      const qrId = 'qr-' + Math.random().toString(36).substring(2, 15);
      c.id = qrId;
      generateQR(qrId, qrPayload);
      
      // Download QR code
      dl.onclick = () => {
        try {
          // Find the canvas inside the QR code container
          const canvas = c.querySelector('canvas');
          if (canvas) {
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `${kind.toLowerCase()}-qr.png`;
            a.click();
          } else {
            alert('Could not generate QR code for download');
          }
        } catch (e) {
          console.error('Error downloading QR code:', e);
          alert('Could not download QR code');
        }
      };
    } else {
      right.innerHTML = '<div class="note">No QR for this rail; use the Open button.</div>';
    }

    $('copyRail').onclick = ()=> navigator.clipboard.writeText(copyText||openHref||'');
    SHEET.classList.add('on');
  }

  // ---------- Build rails ----------
  function buildRails(){
    const p = S.profile, r = p.rails||{}, grid = $('rails'); grid.innerHTML='';
    S.rails = []; // reset

    function push(kind,label,sub,icon,cond){
      if(!cond) return;
      S.rails.push({kind,label,sub});
      grid.appendChild(railItem(kind,label,sub,icon));
    }

    // Group 1: Bank rails
    const bankRails = document.createElement('div');
    bankRails.innerHTML = '<h3>Bank rails</h3>';
    grid.appendChild(bankRails);
    
    push('SEPA','IBAN / SEPA', r.iban||'', 'bank', !!r.iban);
    push('SWISS','Swiss QR‑bill', (r.iban||'').startsWith('CH')|| (r.iban||'').startsWith('LI') ? 'CH/LI IBAN' : '', 'ch', !!(r.iban && ((r.iban||'').startsWith('CH')||(r.iban||'').startsWith('LI')) && (p.ch_city||p.ch_street)));
    push('UPI','UPI', r.upi||'', 'upi', !!r.upi);
    push('PIX','Pix', p.pix_name? (p.pix_name + (p.pix_city?' · '+p.pix_city:'')) : '', 'pix', !!r.pix_key);
    
    // Group 2: Crypto
    const cryptoRails = document.createElement('div');
    cryptoRails.innerHTML = '<h3>Crypto</h3>';
    grid.appendChild(cryptoRails);
    
    push('Lightning','⚡ Lightning', r.lightning_address||r.lnurlp_url||'', 'zap', !!(r.lnurlp_url||r.lightning_address));
    push('BTC','Bitcoin', r.bitcoin_address||'', 'btc', !!r.bitcoin_address);
    push('Solana','Solana', r.solana_usdc_mint? 'Solana Pay (USDC)' : (r.solana_address? 'Solana (SOL)':''), 'sol', !!r.solana_address);
    
    // Group 3: Wallet links
    const walletRails = document.createElement('div');
    walletRails.innerHTML = '<h3>Wallet links</h3>';
    grid.appendChild(walletRails);
    
    push('PayPal','PayPal.Me', r.paypal_me||'', 'pay', !!r.paypal_me);
    push('Revolut','Revolut.me', r.revolut_me||'', 'pay', !!r.revolut_me);
    push('CashApp','Cash App', r.cash_app? ('$'+r.cash_app):'', 'pay', !!r.cash_app);
    push('Venmo','Venmo', r.venmo?('@'+r.venmo):'', 'pay', !!r.venmo);
    push('Zelle','Zelle', r.zelle||'', 'pay', !!r.zelle);
    push('Interac','Interac e‑Transfer', r.interac_email||'', 'pay', !!r.interac_email);
    push('PayID','PayID (AU)', r.payid_au||'', 'pay', !!r.payid_au);
    push('FPS','FPS (HK)', r.fps_id||'', 'pay', !!r.fps_id);

    // Primary CTA
    const primary = pickPrimary();
    const btn = $('primaryCta');
    if (primary){ btn.textContent = `Pay with ${primary}`; btn.onclick = (e)=>{ e.preventDefault(); openRail(primary); }; btn.href='#'; }
    else { btn.textContent='Choose a rail'; btn.onclick = null; btn.href='#rails'; }
  }

  // ---------- Boot ----------
  (function boot(){
    // region
    try {
      S.region = (Intl.DateTimeFormat().resolvedOptions().locale || '').split('-')[1] || '';
    } catch(_) { S.region=''; }

    // hydrate inputs from URL
    amountEl.value = S.qs.get('amount') || '';
    noteEl.value = S.qs.get('note') || '';
    fiatEl.value = (S.qs.get('fiat') || '').toUpperCase();

    // amount chips (contextual)
    const chipVals = ['5','10','20','35','50','100'];
    chipsEl.innerHTML = chipVals.map(v=>`<button class="chip" data-v="${v}">${v}</button>`).join('');
    chipsEl.querySelectorAll('.chip').forEach(b => b.onclick = ()=>{ amountEl.value=b.dataset.v; onInputsChanged(); });

    // events
    amountEl.oninput = onInputsChanged;
    noteEl.oninput = onInputsChanged;
    fiatEl.oninput = onInputsChanged;

    // universal actions
    $('copylink').onclick = ()=> navigator.clipboard.writeText(currentUrl());
    $('share').onclick = async ()=> { if(navigator.share){ try{ await navigator.share({ title: document.title, text: 'Pay via any rail', url: currentUrl() });}catch(e){} } else { await navigator.clipboard.writeText(currentUrl()); alert('link copied'); } };

    // fetch profile
    const profileUrl = `${location.origin}${location.pathname.replace(/index\.html?$/,'')}profiles/${encodeURIComponent(S.qs.get('u'))}.json`;
    fetch(profileUrl).then(r => r.ok ? r.json() : Promise.reject(new Error('profile not found'))).then(p => {
      S.profile = p;
      $('title').textContent = (p.name? `${p.name} — Pay` : 'Pay');
      $('subtitle').textContent = 'One QR, any money.';
      if (p.avatar) { $('avatar').src = p.avatar; } else { $('avatar').style.display='none'; }
      const tags = []; if (p.city) tags.push(`<span class="tag">${p.city}</span>`); if (p.category) tags.push(`<span class="tag">${p.category}</span>`);
      $('meta').innerHTML = tags.join(' ');
      buildRails();
      setUniversalQr();
    }).catch(err=>{
      console.error(err);
      $('title').textContent='UPL'; $('subtitle').textContent='One QR, any money.';
      $('rails').innerHTML = '<div class="muted">No profile found. <a href="make.html">Create your profile</a>.</div>';
      setUniversalQr();
    });
  })();

  function onInputsChanged(){ setUniversalQr(); }
})();
</script>

<!-- Optional Cloudflare Analytics
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token":"YOUR_TOKEN"}'></script>
-->
</body>
</html>